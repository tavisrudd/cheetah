\section{For Cheetah Developers}
\label{developer}

This chapter is for people on the Cheetah development team, and for those who
want the ``inside scoop'' on how Cheetah works.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Adding features to Cheetah}

Whenever you add a feature to Cheetah, follow these steps:

\begin{enumerate}

\item  Add the feature.

\item  Write a regression test for it.  Verify the test suite does not break.

\item  Add an entry to the CHANGES file explaining what you did.

\item  Remove the entry on the TODO list if present.

\item  Update the documentation.

\item  Commit it all.

\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Running regression tests}

Cheetah comes with a set of regression tests to verify it's working properly.
To run the tests:

\begin{enumerate}

\item  \code{cd} into \bf{src/Cheetah/Tests} in the Cheetah source distribution 
     or \bf{site-packages/Cheetah/Tests} in your Python library directory.
     
\item  Run the command:  \code{python Test.py}

\item  It will run 15-30 seconds and then print either "OK" or an error message.

\end{enumerate}

The test suite tries to write the file \bf{parseTest.txt} in the current 
directory if it doesn't exist.  You will get an IOError if you don't have write
permission.  You must run the test suite once as a user with write permission
permission (e.g., root), then you'll be able to run it as any user.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Adding regression tests}

In Tests.py, search for: "### *** ADD NEW TYPES OF POSIX CASES
ABOVE HERE. ***  ###" and add your test.  \code{posixCases} is a list.  Each
element is a list of three strings.  The subscripts are:

\begin{description}

\item{[0]}  A description of the test.

\item{[1]}  A small Template Definition.

\item{[2]}  The expected output.

\end{description}


``Posix cases} means tests which should work on all platforms.  For
platform-specific tests, there are two other lists \code{windowsCases} and
\code{macintoshCases}. 
separate lists 

Look near the top of the file for many Placeholder Names you can refer to.  If
none of these are suitable, you may add additional ones.

There is also a ``BEGIN TODO'' section for tests which have not been written
yet or cannot be performed in the current testing framework.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Safe delegation}

"Safe delegation, as provided by Zope and Allaire's Spectra, is not implemented
in Cheetah.  The core aim has been to help developers and template maintainers
get things done, without throwing unnecessary complications in their
way.  So you should give write access to your templates only to those whom you
trust.  However, several hooks have been built into Cheetah so that safe
delegation can be implemented at a later date.  

It should be possible to implement safe delegation via a future configuration
Setting \code{safeDelegationLevel} (0=none, 1=semi-secure, 2-alcatraz).  This
is not implemented but the steps are listed here in case somebody wants to try
them out and test them.  

Of course, you would also need to benchmark your code
and verify it does not impact performance when safe delegation is off, and 
impacts it only modestly when it is on."  All necessary changes can be made
at compile time, so there should be no performance impact when filling the
same TO multiple times.

\begin{enumerate}

\item  Only give untrusted developers access to the .tmpl files.
(Verifying what this means.  Why can't trusted developers access them?)

\item  Disable the \code{#data} directive and maybe the \code{#set} directive.

\item  Use Cheetah's directive validation hooks to disallow
references to \code{self}, etc
(e.g. \code{#if $steal(self.thePrivateVar)} )

\item  Implement a validator for the $\placeholders and use it
to disallow '\_\_'  in \$placeholders so that tricks like
\code{\$obj.\_\_class\_\_.\_\_dict\_\_} are not possible.

\end{enumerate}


